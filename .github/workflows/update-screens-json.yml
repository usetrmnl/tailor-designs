name: Update Screens JSON
on:
  push:
    branches: [ main ]
    paths:
      - 'screens/**'
  workflow_dispatch:

jobs:
  update-json:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate screens JSON from actual files
      run: |
        # Create JSON array of screen metadata by scanning the screens directory
        echo '[' > screens.json
        
        # Find all PNG files in screens directory and process them
        find screens -name "*.png" -type f | sort | head -n 1000 | while read file; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            # Strip .png extension before splitting
            base="${filename%.png}"
            IFS='-' read -ra parts <<< "$base"

            if [ ${#parts[@]} -ge 3 ]; then
              resolution="${parts[0]}"
              type="${parts[1]}"
              name="${parts[2]}"
              credit=""

              if [ ${#parts[@]} -ge 4 ]; then
                credit="${parts[3]}"
              fi

              width_height=(${resolution//x/ })
              width=${width_height[0]}
              height=${width_height[1]}

              escaped_filename=$(echo "$filename" | sed 's/\\/\\\\/g; s/"/\\"/g')
              escaped_name=$(echo "$name" | sed 's/\\/\\\\/g; s/"/\\"/g')
              escaped_credit=$(echo "$credit" | sed 's/\\/\\\\/g; s/"/\\"/g')

              echo "  {\"filename\":\"$escaped_filename\",\"width\":$width,\"height\":$height,\"type\":\"$type\",\"name\":\"$escaped_name\",\"credit\":\"$escaped_credit\"}," >> screens.json
            fi
          fi
        done
        
        # Remove trailing comma and close array
        sed -i '$ s/,$//' screens.json
        echo ']' >> screens.json
        
        # Validate JSON
        if command -v python3 &> /dev/null; then
          python3 -c "import json; json.load(open('screens.json'))" 2>/dev/null || echo "JSON validation failed"
        fi
        
        cat screens.json
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add screens.json
        git commit -m "Update screens JSON" || echo "No changes to commit"
        git push origin HEAD:main || echo "No changes to push"